<!DOCTYPE html>
<html lang="pt-br" ng-app="tarefaApp">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciador de Tarefas</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding: 20px; background-color: #f8f9fa; }
        .container { max-width: 900px; }
        .table-hover tbody tr { cursor: pointer; }
    </style>
</head>
<body ng-controller="tarefaController">

    <div class="container">
        <h2 class="mb-4">Gerenciador de Tarefas</h2>

        <div class="card mb-4">
            <div class="card-header">
                <h4 ng-if="!tarefa.id">Nova Tarefa</h4>
                <h4 ng-if="tarefa.id">Editando Tarefa: {{tarefa.titulo}}</h4>
            </div>
            <div class="card-body">
                <form ng-submit="salvarTarefa()">
                    <input type="hidden" ng-model="tarefa.id">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="titulo" class="form-label">Título</label>
                            <input type="text" class="form-control" id="titulo" ng-model="tarefa.titulo" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="data" class="form-label">Data</label>
                            <input type="date" class="form-control" id="data" ng-model="tarefa.data" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="descricao" class="form-label">Descrição</label>
                        <textarea class="form-control" id="descricao" rows="2" ng-model="tarefa.descricao"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="status" class="form-label">Status</label>
                        <select class="form-select" id="status" ng-model="tarefa.status" required>
                            <option value="" disabled>Selecione um status</option>
                            <option value="0">Pendente</option>
                            <option value="1">Em Andamento</option>
                            <option value="2">Finalizado</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary">{{ tarefa.id ? 'Atualizar' : 'Salvar' }}</button>
                    <button type="button" class="btn btn-secondary" ng-click="limparFormulario()" ng-if="tarefa.id">Cancelar Edição</button>
                </form>
            </div>
        </div>

        <h3>Lista de Tarefas</h3>
        <table class="table table-hover table-bordered bg-white">
            <thead class="table-dark">
                <tr>
                    <th>Título</th>
                    <th>Data</th>
                    <th>Status</th>
                    <th>Ações</th>
                </tr>
            </thead>
            <tbody>
                <tr ng-repeat="t in tarefas">
                    <td>{{ t.titulo }}</td>
                    <td>{{ t.data | date:'dd/MM/yyyy' }}</td>
                    <td>{{ getStatusTexto(t.status) }}</td>
                    <td>
                        <button class="btn btn-sm btn-warning me-2" ng-click="editarTarefa(t)">Editar</button>
                        <button class="btn btn-sm btn-danger" ng-click="deletarTarefa(t.id)">Excluir</button>
                    </td>
                </tr>
                <tr ng-if="!tarefas.length">
                    <td colspan="4" class="text-center">Nenhuma tarefa encontrada.</td>
                </tr>
            </tbody>
        </table>
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.2/angular.min.js"></script>
    <script>
        var app = angular.module('tarefaApp', []);

        app.controller('tarefaController', function($scope, $http) {

            var apiUrl = 'https://localhost:7295/Tarefa';

            $scope.tarefas = []; 
            $scope.tarefa = {}; 

            // Função para carregar todas as tarefas da API
            function carregarTarefas() {
                $http.get(apiUrl + '/ObterTodos')
                    .then(function(response) {
                        $scope.tarefas = response.data;
                    })
                    .catch(function(error) {
                        console.error('Erro ao buscar tarefas:', error);
                        alert('Não foi possível carregar as tarefas.');
                    });
            }

            // Função para salvar (criar ou atualizar) uma tarefa
            $scope.salvarTarefa = function() {
                if ($scope.tarefa.id) {
                    $http.put(apiUrl + '/' + $scope.tarefa.id, $scope.tarefa)
                        .then(function() {
                            alert('Tarefa atualizada com sucesso!');
                            limparFormulario();
                            carregarTarefas();
                        })
                        .catch(function(error) {
                            console.error('Erro ao atualizar tarefa:', error);
                            alert('Erro ao atualizar a tarefa.');
                        });
                }
                else {
                    $http.post(apiUrl, $scope.tarefa)
                        .then(function() {
                            alert('Tarefa criada com sucesso!');
                            limparFormulario();
                            carregarTarefas();
                        })
                        .catch(function(error) {
                            console.error('Erro ao criar tarefa:', error);
                            alert('Erro ao criar a tarefa.');
                        });
                }
            };

            // Prepara o formulário para edição
            $scope.editarTarefa = function(tarefa) {
                $scope.tarefa = angular.copy(tarefa);
                $scope.tarefa.data = new Date(tarefa.data);
                $scope.tarefa.status = tarefa.status.toString();
            };

            // Deleta uma tarefa
            $scope.deletarTarefa = function(id) {
                if (confirm('Tem certeza que deseja excluir esta tarefa?')) {
                    $http.delete(apiUrl + '/' + id)
                        .then(function() {
                            alert('Tarefa excluída com sucesso!');
                            carregarTarefas();
                        })
                        .catch(function(error) {
                            console.error('Erro ao excluir tarefa:', error);
                            alert('Erro ao excluir a tarefa.');
                        });
                }
            };
            
            // Converte o número do status para um texto legível
            $scope.getStatusTexto = function(statusNumero) {
                switch(statusNumero) {
                    case 0: return 'Pendente';
                    case 1: return 'Finalizado';
                }
            };

            // Limpa o formulário
            function limparFormulario() {
                $scope.tarefa = {};
            }
            $scope.limparFormulario = limparFormulario;

            carregarTarefas();
        });
    </script>
</body>
</html>